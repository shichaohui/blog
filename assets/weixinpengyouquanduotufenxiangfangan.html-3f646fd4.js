import{_ as i,p as o,q as p,s as n,R as s,t as e,Y as t,n as c}from"./framework-a25df3d5.js";const l={},u={href:"https://shichaohui.github.io/",target:"_blank",rel:"noopener noreferrer"},r={href:"https://github.com/shichaohui/WXShareMultiImage",target:"_blank",rel:"noopener noreferrer"},d={href:"https://github.com/shichaohui/WXShareMultiImage",target:"_blank",rel:"noopener noreferrer"},k=t(`<p><img src="https://s1.ax1x.com/2023/03/24/ppBGtKK.png" alt="无法分享到微信"></p><p>前些日子微信更新到了 v6.7.3 版本，传统的多图分享方式已经无效了。</p><h2 id="微信-v6-7-3-版本以前的方案" tabindex="-1"><a class="header-anchor" href="#微信-v6-7-3-版本以前的方案" aria-hidden="true">#</a> 微信 v6.7.3 版本以前的方案</h2><p>微信在 v6.7.3 以前的版本提供了从系统相册分享多图到朋友圈的接口，具体使用如下：</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
intent<span class="token punctuation">.</span>action <span class="token operator">=</span> Intent<span class="token punctuation">.</span>ACTION_SEND_MULTIPLE
intent<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token function">ComponentName</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;com.tencent.mm&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;com.tencent.mm.ui.tools.ShareToTimeLineUI&quot;</span></span><span class="token punctuation">)</span>
intent<span class="token punctuation">.</span>type <span class="token operator">=</span> &quot;image<span class="token comment">/*&quot;
intent.putStringArrayListExtra(Intent.EXTRA_TEXT, arrayListOf(text))
intent.putExtra(&quot;Kdescription&quot;, text)
// 传递多张图片的 Uri 。
intent.putParcelableArrayListExtra(Intent.EXTRA_STREAM, uriList)
startActivity(intent)
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用以上代码，在微信 v6.7.3 以前可以正常分享，但是如果用户把微信更新到 v6.7.3 版本，再使用该分案分享多图就只能看到上面那张图了。</p><h2 id="跳转微信-v6-7-3-图文分享界面" tabindex="-1"><a class="header-anchor" href="#跳转微信-v6-7-3-图文分享界面" aria-hidden="true">#</a> 跳转微信 v6.7.3 图文分享界面</h2><p>虽然 v6.7.3 不能直接分享多图了，但是接口其实还是保留了的，只要在传递参数 <code>Intent.EXTRA_STREAM</code> 时 urilList 中只携带 1 张图片，还是可以跳转到朋友圈图文分享界面的。如下：</p><p><img src="https://s1.ax1x.com/2023/03/24/ppBGNDO.png" alt="微信图文分享界面"></p>`,9),v={href:"https://github.com/shichaohui/WXShareMultiImage",target:"_blank",rel:"noopener noreferrer"},m=n("p",null,"此界面和从朋友圈中通过选择图片后跳转的界面是一模一样的，不仅可以分享图片，还可以发送文字、定位、同步到QQ空间。",-1),h=n("p",null,[s("但是，仅仅打开图文分享界面是不行的，因为我们要的是多图分享，而这里只传入了 1 张图片。为了解决这个问题，需要用到 "),n("code",null,"AccessibilityService"),s("。")],-1),b=n("h2",{id:"使用无障碍服务",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#使用无障碍服务","aria-hidden":"true"},"#"),s(" 使用无障碍服务")],-1),g={href:"https://developer.android.com/guide/topics/ui/accessibility/",target:"_blank",rel:"noopener noreferrer"},f=t(`<blockquote><p>无障碍服务是一个为残疾人或可能暂时无法与设备完全互动的人提供用户界面扩展功能的服务。</p></blockquote><p>从Android4.0（API级别14）开始，无障碍服务可以代表用户操作，包含改变输入焦点和选择（激活）用户界面元素。在Android4.1（API级别16），操作的范围被扩展至包含滚动列表和与文本域交互。无障碍服务也可采取全局操作，如导航到主界面、按返回按钮、打开屏幕通知和最近应用列表。Android4.1也包含新焦点类型，无障碍焦点，该焦点类型可让所有视觉元素能够被无障碍服务所选择。</p><p>这些新的能力让开发者能够开发替代导航模式，如手势导航，提高残障用户对Android设备的控制。</p><p>通过使用无障碍服务，可以监听用户手机界面和事件，并在特定事件产生时代替用户执行一些操作。因此我们只要知道分析朋友圈图文分享界面的事件，找到合适的事件帮助用户自动填写文字、自动选择图片即可。</p><p><strong>注意：由于无障碍服务功能强大，因此 Android 系统对其进行了限制，必须用户手动打开 APP 开发的无障碍服务，才能产生作用。</strong></p><h3 id="事件分析" tabindex="-1"><a class="header-anchor" href="#事件分析" aria-hidden="true">#</a> 事件分析</h3><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">class</span> WXShareMultiImageService <span class="token operator">:</span> <span class="token function">AccessibilityService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onAccessibilityEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> AccessibilityEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当窗口发生的事件是我们配置监听的事件时,会回调此方法.会被调用多次</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//当服务要被中断时调用.会被调用多次</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每次产生的事件都会发送到 <code>onAccessibilityEvent</code> 函数，通过打印 <code>AccessibilityEvent</code> 的内容分析事件，发现以下事件：</p><ul><li>打开图文分享界面时产生的事件:</li></ul><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    eventType <span class="token operator">:</span> AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED
    className <span class="token operator">:</span> com.tencent.mm.plugin.sns.ui.SnsUploadUI
    ...
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>点击添加图片的 + 号产生的事件：</li></ul><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    eventType <span class="token operator">:</span> AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED
    className <span class="token operator">:</span> android.widget.ListView
    ...
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>打开图片选择界面的事件：</li></ul><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    eventType <span class="token operator">:</span> AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED
    className <span class="token operator">:</span> com.tencent.mm.plugin.gallery.ui.AlbumPreviewUI
    ...
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分析图文分享界面的-ui" tabindex="-1"><a class="header-anchor" href="#分析图文分享界面的-ui" aria-hidden="true">#</a> 分析图文分享界面的 UI</h3><p>使用 Android SDK 的 <code>uiautomatorviewer</code> 工具分析 UI，找到如下视图：</p><ul><li>文字编辑框（EditText）。</li><li>已选图片列表（GridView），最后一个 Item 是【添加图片按钮】。</li><li>添加图片方式列表（ListView），最后一个 Item 是【从相册选择】。</li><li>待选图片列表（GridView）。</li><li>复选框（CheckBox），其实点击的不是 CheckBox，而是另一个不可见的 View。</li><li>【完成】选择按钮。</li></ul><p><code>AccessibilityService</code> 中获取视图节点的 3 种方式：</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">// 通过 id  获取节点。</span>
rootNodeInfo<span class="token punctuation">.</span><span class="token function">findAccessibilityNodeInfosByViewId</span><span class="token punctuation">(</span>idString<span class="token punctuation">)</span>

<span class="token comment">// 通过文本获取节点。</span>
rootNodeInfo<span class="token punctuation">.</span><span class="token function">findAccessibilityNodeInfosByText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>

<span class="token comment">// 遍历子节点获取指定节点。</span>
<span class="token keyword">fun</span> <span class="token function">findNodeInfo</span><span class="token punctuation">(</span>rootNodeInfo<span class="token operator">:</span> AccessibilityNodeInfo<span class="token operator">?</span><span class="token punctuation">,</span> className<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> AccessibilityNodeInfo<span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历，具体内容请查看源码。</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>微信每个版本的视图 id 都不一样，为了版本兼容，不能使用 id 获取节点。</p><p>通过 text 文本获取节点只对有 text 属性且有值的节点有效。</p><p>因此大多数节点通过遍历子节点的形式获取。</p><h3 id="自动粘贴" tabindex="-1"><a class="header-anchor" href="#自动粘贴" aria-hidden="true">#</a> 自动粘贴</h3><p>将待分享的文字复制到系统剪切板，如果用户打开了无障碍服务，服务将自动粘贴文字到输入框，否则用户也可以手动长按输入框粘贴。</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token keyword">val</span> editText <span class="token operator">=</span> <span class="token function">findNodeInfo</span><span class="token punctuation">(</span>rootInActiveWindow<span class="token punctuation">,</span> EditText<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>JELLY_BEAN_MR2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 粘贴剪切板内容</span>
    editText<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">performAction</span><span class="token punctuation">(</span>AccessibilityNodeInfo<span class="token punctuation">.</span>ACTION_FOCUS<span class="token punctuation">)</span>
    editText<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">performAction</span><span class="token punctuation">(</span>AccessibilityNodeInfo<span class="token punctuation">.</span>ACTION_PASTE<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    editText<span class="token operator">?</span><span class="token punctuation">.</span>text <span class="token operator">=</span> ClipboardUtil<span class="token punctuation">.</span><span class="token function">getPrimaryClip</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自动选图" tabindex="-1"><a class="header-anchor" href="#自动选图" aria-hidden="true">#</a> 自动选图</h3><p>用户点击分享时下载并记录图片，如果用户打开了无障碍服务，服务将代替用户自动选择图片，否则用户也可以进入相册手动选择图片。</p><div class="language-kotlin line-numbers-mode" data-ext="kt"><pre class="language-kotlin"><code><span class="token comment">// 以下几个步骤是异步的，这里只是为了方便才写在了一起。</span>

<span class="token comment">// 第一步： 自动点击添加图片的 + 号按钮。</span>
<span class="token keyword">val</span> gridView <span class="token operator">=</span> <span class="token function">findNodeInfo</span><span class="token punctuation">(</span>rootInActiveWindow<span class="token punctuation">,</span> GridView<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
gridView<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getChild</span><span class="token punctuation">(</span>gridView<span class="token punctuation">.</span>childCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">performAction</span><span class="token punctuation">(</span>AccessibilityNodeInfo<span class="token punctuation">.</span>ACTION_CLICK<span class="token punctuation">)</span>

<span class="token comment">// 第二步：点击【从相册选择】按钮。</span>
listView<span class="token punctuation">.</span><span class="token function">findAccessibilityNodeInfosByText</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;从相册选择&quot;</span></span><span class="token punctuation">)</span>
        <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token operator">?</span><span class="token punctuation">.</span>parent
        <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">performAction</span><span class="token punctuation">(</span>AccessibilityNodeInfo<span class="token punctuation">.</span>ACTION_CLICK<span class="token punctuation">)</span>

<span class="token comment">// 第三步：选择图片。</span>
<span class="token keyword">val</span> gridView <span class="token operator">=</span> <span class="token function">findNodeInfo</span><span class="token punctuation">(</span>rootInActiveWindow<span class="token punctuation">,</span> GridView<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> ShareInfo<span class="token punctuation">.</span><span class="token function">getSelectedImageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">..</span>ShareInfo<span class="token punctuation">.</span><span class="token function">getWaitingImageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">findNodeInfo</span><span class="token punctuation">(</span>gridView<span class="token punctuation">.</span><span class="token function">getChild</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> View<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">performAction</span><span class="token punctuation">(</span>AccessibilityNodeInfo<span class="token punctuation">.</span>ACTION_CLICK<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 第四步：点击【完成】按钮。</span>
rootInActiveWindow<span class="token punctuation">.</span><span class="token function">findAccessibilityNodeInfosByText</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;完成&quot;</span></span><span class="token punctuation">)</span>
        <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">performAction</span><span class="token punctuation">(</span>AccessibilityNodeInfo<span class="token punctuation">.</span>ACTION_CLICK<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,28),_={id:"详细内容请-查看源码-。",tabindex:"-1"},I=n("a",{class:"header-anchor",href:"#详细内容请-查看源码-。","aria-hidden":"true"},"#",-1),A={href:"https://github.com/shichaohui/WXShareMultiImage",target:"_blank",rel:"noopener noreferrer"},y=n("p",null,"为了方便大家使用新的分享方案，我这里已经封装成组件 ，并发布源码到 Github。",-1),x=n("p",null,"https://github.com/shichaohui/WXShareMultiImage",-1),N=n("h2",{id:"完整的多图分享流程",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#完整的多图分享流程","aria-hidden":"true"},"#"),s(" 完整的多图分享流程")],-1),T=n("p",null,[n("img",{src:"https://s1.ax1x.com/2023/03/24/ppBGdVe.png",alt:"流程图"})],-1),w={id:"下载-demo",tabindex:"-1"},E=n("a",{class:"header-anchor",href:"#下载-demo","aria-hidden":"true"},"#",-1),S={href:"https://github.com/shichaohui/WXShareMultiImage/blob/master/demo.apk",target:"_blank",rel:"noopener noreferrer"},C={id:"github-查看源码",tabindex:"-1"},V=n("a",{class:"header-anchor",href:"#github-查看源码","aria-hidden":"true"},"#",-1),q={href:"https://github.com/shichaohui/WXShareMultiImage",target:"_blank",rel:"noopener noreferrer"},L=t('<h2 id="优缺点" tabindex="-1"><a class="header-anchor" href="#优缺点" aria-hidden="true">#</a> 优缺点</h2><p><strong>优点</strong></p><ol start="0"><li>可自动粘贴分享文字。</li><li>可自动选择指定的多张图片。</li><li>服务不可用时会自动降级，由用户手动选择图片。</li></ol><p><strong>缺点</strong></p><ol start="0"><li>无法获取分享结果。</li><li>需用户手动打开服务。</li><li>部分机型在关闭APP时会自动关闭服务。</li><li>微信更新朋友圈图文分享界面可能导致方案失效。</li></ol>',5);function O(W,B){const a=c("ExternalLinkIcon");return o(),p("div",null,[n("blockquote",null,[n("p",null,[n("small",null,[s("转载请注明出处，"),n("a",u,[s("点击此处"),e(a)]),s(" 查看更多精彩内容。")])])]),n("p",null,[n("a",r,[s("Github 查看源码"),e(a)])]),n("blockquote",null,[n("p",null,[s("本库经过几个版本的升级，当前的分享逻辑和本文中略有不同，但整体思想是一致的，实际方案请"),n("a",d,[s("阅读源码"),e(a)]),s("。")])]),k,n("blockquote",null,[n("p",null,[s("微信 v7.0.x 不能使用 Intent.ACTION_SEND_MULTIPLE 分享了，只能使用 Intent.ACTION_SEND，具体解决方案请"),n("a",v,[s("阅读源码"),e(a)]),s("。")])]),m,h,b,n("p",null,[n("a",g,[s("AccessibilityService 官方文档"),e(a)])]),f,n("h2",_,[I,s(" 详细内容请 "),n("a",A,[s("查看源码"),e(a)]),s(" 。")]),y,x,N,T,n("h2",w,[E,s(),n("a",S,[s("下载 Demo"),e(a)])]),n("h2",C,[V,s(),n("a",q,[s("Github 查看源码"),e(a)])]),L])}const D=i(l,[["render",O],["__file","weixinpengyouquanduotufenxiangfangan.html.vue"]]);export{D as default};
